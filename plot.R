#!/usr/bin/env Rscript
library(argparse)
library(ggplot2)
library(dplyr)
library(scales)
library(ggthemes)
library(ggrepel)
library(cowplot)

parser <-
  ArgumentParser(description = "", formatter_class = "argparse.RawTextHelpFormatter")
parser$add_argument("-i", "--infile", type = "character",
                    help = "result file generated by run.pl")
parser$add_argument("-o",
                    "--outfile",
                    type = "character",
                    default = "",
                    help = "result figure file")
parser$add_argument("--width",
                    type = "double",
                    default = 8,
                    help = "result file width")
parser$add_argument("--height",
                    type = "double",
                    default = 6,
                    help = "result file height")
parser$add_argument("--lx",
                    type = "double",
                    default = 0.85,
                    help = "x of legend position")
parser$add_argument("--ly",
                    type = "double",
                    default = 0.25,
                    help = "y of legend position")
parser$add_argument("--dpi",
                    type = "integer",
                    default = 300,
                    help = "DPI")
parser$add_argument("--labcolor",
                    type = "character",
                    default = "Tools",
                    help = "label of color")
parser$add_argument("--labshape",
                    type = "character",
                    default = "Datasets",
                    help = "label of shape")

args <- parser$parse_args()

if (is.null(args$infile)) {
  write("ERROR: Input file (generated by run.pl) needed!\n", file = stderr())
  quit("no", 1)
}
if (args$outfile == "") {
  args$outfile = paste(args$infile, ".png", sep = "")
}

w <- args$width
h <- args$height

df <- read.csv(args$infile, sep = "\t")

df <-
  df %>% mutate(dataset, filetype = ifelse(endsWith(dataset, ".gz"), "gzip-compressed", "plain text"))
df$dataset <- gsub(".gz", "", df$dataset)

# df <- df %>% filter(!grepl("gzip", app))

# sort
df$test <- factor(df$test, levels = unique(df$test), ordered = TRUE)
df$dataset <-
  factor(df$dataset,
         levels = unique(df$dataset),
         ordered = TRUE)
# since in some test there are only part of tools, we need to set them separately
tests <- unique(df$test)
levels <- unique(df$app[df$test==tests[1]])
levels2 <- unique(df$app[df$test==tests[2]])
levels <- append(levels,  levels2[!(levels2 %in% levels)])
df$app <- factor(df$app, levels = levels, ordered = TRUE)

# humanize mem unit
max_mem <- max(df$mem)
unit <- "KB"
if (max_mem > 1024 * 1024) {
  df <- df %>% mutate(mem2 = mem / 1024 / 1024)
  unit <- "GB"
} else if (max_mem > 1024) {
  df <- df %>% mutate(mem2 = mem / 1024)
  unit <- "MB"
} else {
  df <- df %>% mutate(mem2 = mem / 1)
  unit <- "KB"
}

df2 <- df %>%
  group_by(test, dataset, filetype, app) %>%
  summarize(
    mem_stdev = sd(mem2) / sqrt(length(mem2)),
    mem_mean = mean(mem2),
    time_stdev = sd(time) / sqrt(length(time)),
    time_mean = mean(time)
  )

# n <- length(unique(df$app))
# colors0 <- c("#F55951", "grey50", "grey70", "grey90")
# if (n>7) {
#   colors <- colorblind_pal()(7 + 1)[2:(7 + 1)] # begin with 2nd color
#   for (i in seq(1, n-7)) {
#     colors <- append(colors, colors0[i])
#   }
# } else {
#   colors <- colorblind_pal()(n + 1)[2:(n + 1)] # begin with 2nd color
# }
colors <- c("#009E73", "#0072B2", "#56B4E9",  "#F0E442",  "#D55E00", "grey50", "#E69F00", "#F55951", "grey40")

plotit <- function(df2) {
  p <-
    ggplot(
      df2,
      aes(
        x = mem_mean,
        y = time_mean,
        xmin = mem_mean - mem_stdev,
        xmax = mem_mean + mem_stdev,
        ymin = time_mean - time_stdev,
        ymax = time_mean + time_stdev,
        color = app,
        shape = dataset,
        label = dataset
      )
    ) +
    
    geom_point(size = 3.5, alpha = 0.7) +
    
    scale_color_manual(values = colors) +
    facet_grid(filetype ~ test, scales = "free") +
    # ylim(0, max(df$time)) +
    # xlim(0, max(df$mem2)) +
    
    ylab("Time (s)") +
    xlab(paste("Peak Memory (", unit, ")", sep = "")) +
    labs(color = args$labcolor, shape = args$labshape)
  
  p <- p +
    theme_bw() +
    theme(
      panel.border = element_rect(color = "grey20", size = 0.8),
      panel.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      plot.margin = unit(c(0.1, 0.4, 0.1, 0.1), "cm"),
      axis.ticks.y = element_line(size = 0.6),
      axis.ticks.x = element_line(size = 0.6),
      
      strip.background = element_rect(
        colour = "white",
        fill = "grey95",
        size = 0.2
      ),
      strip.text.x = element_text(size = 10.5),
      strip.text.y = element_text(size = 12.5),
      
      legend.text = element_text(size = 11),
      # legend.position = c(args$lx,args$ly),
      legend.position = "right",
      legend.background = element_rect(fill = "transparent"),
      legend.key.size = unit(0.6, "cm"),
      legend.key = element_blank(),
      legend.text.align = 0,
      legend.box.just = "left",
      legend.spacing.y = unit(0.1, "cm"),
      # space between key and text
      
      text = element_text(
        size = 12,
        family = "arial"),
    )
  
  return(p)
}




a <- plotit(df2 %>% filter(test == tests[1]))
b <- plotit(df2 %>% filter(test == tests[2]))
c <- plotit(df2 %>% filter(test == tests[3]))
# create some space to the left of the legend
legend <- get_legend( c + theme(legend.box.margin = margin(0, 0, 0, -21)))

p <- plot_grid(
  a + theme(
    legend.position = "none",
    strip.text.y = element_blank(),
    axis.title.x = element_text(color = "white")
  ),
  b + theme(
    legend.position = "none",
    strip.text.y = element_blank(),
    axis.title.y = element_blank()
  ),
  c + theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.title.x = element_text(color = "white")
  ),
  legend,
  ncol = 4,
  rel_widths = c(0.88, 0.88, 0.96, 0.66)
) + theme ( # fill the gap in sub figures
  panel.background = element_rect(fill = "white", colour = NA),
) 

if (grepl("tiff?$",
          args$outfile,
          perl = TRUE,
          ignore.case = TRUE)) {
  ggsave(
    p,
    file = args$outfile,
    width = w,
    height = h,
    dpi = args$dpi,
    compress =
      "lzw"
  )
} else {
  ggsave(
    p,
    file = args$outfile,
    width = w,
    height = h,
    dpi = args$dpi
  )
}
